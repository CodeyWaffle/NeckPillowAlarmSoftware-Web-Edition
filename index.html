<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pillow Alarm Pro</title>
    <style>
        :root { --primary: #1f6feb; --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --accent: #00FFD4; --error: #da3633; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; text-align: center; padding: 20px; margin: 0; }
        h2 { color: white; margin-bottom: 25px; font-weight: 600; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #30363d; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        button { background: var(--primary); border: none; padding: 16px 20px; border-radius: 12px; color: white; font-weight: bold; font-size: 16px; margin: 10px 0; width: 100%; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.97); opacity: 0.8; }
        .stop-btn { background: var(--error); }
        #terminal { background: #000; color: var(--accent); padding: 15px; border-radius: 10px; height: 180px; overflow-y: auto; text-align: left; font-family: "SF Mono", "Fira Code", monospace; font-size: 13px; border: 1px solid #30363d; line-height: 1.5; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online { background-color: #238636; box-shadow: 0 0 8px #238636; }
    </style>
</head>
<body>

    <h2><span id="dot" class="status-dot"></span>Pillow Alarm</h2>

    <div class="card">
        <button onclick="connect()">ðŸ”— Pair with Pillow</button>
    </div>

    <div class="card">
        <button onclick="send('/unlock')">ðŸ”“ UNLOCK DEVICE</button>
        <button class="stop-btn" onclick="send('/alarm_stop')">ðŸ›‘ STOP ALARM</button>
    </div>

    <div class="card" style="padding: 10px;">
        <div id="terminal">System: Ready.<br>Open this in Bluefy Browser...</div>
    </div>

    <script>
        let device, characteristic;

        // Standard HM-10 / ESP32 UUIDs
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHAR_UUID    = "0000ffe1-0000-1000-8000-00805f9b34fb";

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        async function connect() {
            try {
                log("Requesting Device...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });

                log("Connecting to GATT...");
                const server = await device.gatt.connect();
                await sleep(500); // iPhone Delay Fix

                log("Getting Service...");
                const service = await server.getPrimaryService(SERVICE_UUID);
                await sleep(500); // iPhone Delay Fix

                log("Getting Characteristic...");
                characteristic = await service.getCharacteristic(CHAR_UUID);
                
                log("Starting Notifications...");
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (e) => {
                    let val = new TextDecoder().decode(e.target.value);
                    log("Pillow: " + val);
                });

                document.getElementById('dot').classList.add('online');
                log("CONNECTED âœ…");
            } catch (err) {
                log("ERROR: " + err.message);
                console.error(err);
            }
        }

        async function send(msg) {
            if (!characteristic) {
                log("Not connected!");
                return;
            }
            try {
                const data = new TextEncoder().encode(msg);
                await characteristic.writeValue(data);
                log("Sent: " + msg);
            } catch (err) {
                log("Send Error: " + err.message);
            }
        }

        function log(m) {
            const t = document.getElementById('terminal');
            t.innerHTML += `<br>> ${m}`;
            t.scrollTop = t.scrollHeight;
        }
    </script>
</body>
</html>
