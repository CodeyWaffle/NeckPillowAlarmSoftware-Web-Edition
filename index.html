<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeckPillowAlarm Web Control</title>
    <style>
        /* Dark Theme Styles */
        body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system, sans-serif; text-align: center; padding: 20px; margin: 0; }
        
        /* Layout */
        .container { max-width: 400px; margin: 0 auto; }
        .card { background: #161b22; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #30363d; text-align: left; }
        .row { display: flex; gap: 10px; margin-top: 10px; }
        
        /* Inputs & Typography */
        h3 { margin: 0 0 10px 0; font-size: 14px; color: #58a6ff; text-transform: uppercase; }
        input[type="time"] { background: #0d1117; color: #fff; border: 1px solid #30363d; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 18px; display: block; }
        
        /* Buttons */
        button { border: none; padding: 15px; border-radius: 8px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        
        .btn-connect { background: #238636; margin-bottom: 20px; }
        .btn-action { background: #1f6feb; margin-top: 10px; }
        .btn-red { background: #da3633; }
        .btn-gray { background: #21262d; border: 1px solid #30363d; }

        /* Terminal */
        #terminal { background: #000; color: #00FFD4; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #30363d; text-align: left; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">

    <button class="btn-connect" onclick="connect()">üîó Connect BLE</button>

    <div class="card">
        <h3>‚è∞ Set Alarm</h3>
        <input type="time" id="alarmPicker">
        <button class="btn-action" onclick="sendAlarm()">Set Alarm (/alarm)</button>
    </div>

    <div class="card">
        <h3>üïí Set RTC Time</h3>
        <input type="time" id="rtcPicker">
        <button class="btn-action" onclick="sendRTC()">Set Time (/rtc)</button>
    </div>

    <div class="card">
        <h3>üîí Settings</h3>
        <div class="row">
            <button class="btn-gray" onclick="send('/unlock')">Unlock</button>
            <button class="btn-gray" onclick="send('/lock')">Lock</button>
        </div>
    </div>

    <div class="card">
        <h3>üîä Audio</h3>
        <div class="row">
            <button class="btn-gray" onclick="send('/sound on')">Sound Mode</button>
            <button class="btn-gray" onclick="send('/sound off')">Vibration Mode</button>
        </div>
    </div>

    <div id="terminal">> Waiting for connection...</div>

</div>

<script>
    let char;
    // Standard HM-10 / ESP32 UUIDs
    const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
    const CHAR_UUID    = "0000ffe1-0000-1000-8000-00805f9b34fb";

    // 1. Connect to Device
    async function connect() {
        try {
            log("Scanning...");
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERVICE_UUID] }]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            char = await service.getCharacteristic(CHAR_UUID);

            // Listen for data from Arduino
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (event) => {
                const decoder = new TextDecoder();
                const value = decoder.decode(event.target.value);
                log("Received: " + value);
            });

            log("‚úÖ Connected!");
        } catch (error) {
            log("‚ùå Error: " + error);
        }
    }

    // 2. Helper to send text commands
    async function send(command) {
        if (!char) {
            log("‚ö†Ô∏è Not Connected!");
            return;
        }
        try {
            const encoder = new TextEncoder();
            await char.writeValue(encoder.encode(command));
            log("Sent: " + command);
        } catch (error) {
            log("‚ùå Send Failed: " + error);
        }
    }

    // 3. Special Function for Alarm
    function sendAlarm() {
        const time = document.getElementById('alarmPicker').value;
        if (!time) return log("‚ö†Ô∏è Pick a time first!");
        send("/alarm " + time); // Sends: /alarm 14:30
    }

    // 4. Special Function for RTC
    function sendRTC() {
        const time = document.getElementById('rtcPicker').value;
        if (!time) return log("‚ö†Ô∏è Pick a time first!");
        send("/rtc " + time); // Sends: /rtc 14:30
    }

    // 5. Logger Function
    function log(message) {
        const term = document.getElementById('terminal');
        term.innerHTML += "<br>> " + message;
        term.scrollTop = term.scrollHeight; // Auto-scroll to bottom
    }
</script>

</body>
</html>
