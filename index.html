<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeckPillowAlarm Web Control</title>
    <style>
        /* GLOBAL RESET - Fixes width/border issues */
        * { box-sizing: border-box; }

        /* Theme Styles */
        body { 
            background-color: #6E75A8; /* Valid Hex Color ‚úÖ */
            color: #c9d1d9; 
            font-family: -apple-system, sans-serif; 
            text-align: center; 
            padding: 20px; 
            margin: 0; 
        }
        
        /* Layout */
        .container { max-width: 400px; margin: 0 auto; }
        .card { background: #161b22; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #30363d; text-align: left; }
        .row { display: flex; gap: 10px; margin-top: 10px; }
        
        /* Typography */
        h1 { color: white; font-size: 22px; margin-bottom: 25px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        h3 { margin: 0 0 10px 0; font-size: 14px; color: #58a6ff; font-weight: 600; }
        
        /* Inputs */
        input[type="time"] { 
            background: #0d1117; 
            color: #fff; 
            border: 1px solid #30363d; 
            padding: 12px; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 18px; 
            display: block; 
            margin-bottom: 12px; /* Added spacing below input */
            outline: none;
        }
        
        /* Buttons */
        button { border: none; padding: 15px; border-radius: 8px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        
        .btn-connect { background: #238636; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-action { background: #1f6feb; }
        .btn-red { background: #da3633; color: white; margin-bottom: 15px; }
        .btn-gray { background: #21262d; border: 1px solid #30363d; }

        /* Terminal */
        #terminal { background: #000; color: #00FFD4; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #30363d; text-align: left; margin-top: 10px; }
    </style>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="Icon.png">
</head>
<body>

<div class="container">

    <h1>NeckPillowAlarm Web Control</h1>

    <button class="btn-connect" onclick="connect()">üîó Connect BLE</button>

    <div class="card">
        <h3>‚è∞ Set Alarm</h3>
        <input type="time" id="alarmPicker">
        <button class="btn-action" onclick="sendAlarm()">Set Alarm</button>
    </div>

    <div class="card">
        <h3>üïí Set RTC Time</h3>
        <input type="time" id="rtcPicker">
        <button class="btn-action" onclick="sendRTC()">Set RTC</button>
    </div>

    <div class="card">
        <h3>‚öôÔ∏è Settings</h3>
        <div class="row">
            <button class="btn-gray" onclick="send('/unlock')">üîì Unlock</button>
            <button class="btn-gray" onclick="send('/lock')">üîí Lock</button>
        </div>
    </div>

    <div class="card">
        <h3>üîà Audio</h3>
        <div class="row">
            <button class="btn-gray" onclick="send('/sound on')">üîä Sound Mode</button>
            <button class="btn-gray" onclick="send('/sound off')">üîá Vibration Mode</button>
        </div>
    </div>

    <button class="btn-red" onclick="send('/stop')">üõë Stop Alarm</button>

    <div id="terminal">> Waiting for connection...</div>

</div>

<script>
    // 1. Service Worker for Offline Support
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(() => console.log("Offline mode ready!"))
          .catch((err) => console.log("Offline setup failed", err));
    }

    // 2. BLE Variables
    let rxChar, txChar;
    const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; 
    const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; 

    // 3. Connection Logic
    async function connect() {
        try {
            log("Scanning for Nordic UART...");
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERVICE_UUID] }]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            
            rxChar = await service.getCharacteristic(RX_UUID);
            txChar = await service.getCharacteristic(TX_UUID);

            await txChar.startNotifications();
            txChar.addEventListener('characteristicvaluechanged', (event) => {
                const decoder = new TextDecoder();
                const value = decoder.decode(event.target.value);
                log("Received: " + value);
            });

            log("‚úÖ Connected via Nordic!");
        } catch (error) {
            log("‚ùå Error: " + error);
        }
    }

    // 4. Send Logic
    async function send(command) {
        if (!rxChar) return log("‚ö†Ô∏è Not Connected!");
        try {
            const encoder = new TextEncoder();
            await rxChar.writeValue(encoder.encode(command));
            log("Sent: " + command);
        } catch (error) {
            log("‚ùå Send Failed: " + error);
        }
    }

    function sendAlarm() {
        const time = document.getElementById('alarmPicker').value; 
        if (!time) return log("‚ö†Ô∏è Pick a time first!");
        send("/alarm " + time);
    }

    function sendRTC() {
        const time = document.getElementById('rtcPicker').value;
        if (!time) return log("‚ö†Ô∏è Pick a time first!");
        send("/rtc " + time);
    }

    function log(message) {
        const term = document.getElementById('terminal');
        term.innerHTML += "<br>> " + message;
        term.scrollTop = term.scrollHeight;
    }
</script>

</body>
</html>
