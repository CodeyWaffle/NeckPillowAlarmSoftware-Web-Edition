<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeckPillowAlarm Web Control</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="Icon.png">

    <style>
        /* 1. GLOBAL RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #6E75A8; 
            color: #ffffff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center; 
            padding: 20px 15px; 
            margin: 0;
            overflow-x: hidden; 
        }

        /* 2. LAYOUT CONTAINER */
        .container { 
            max-width: 420px; 
            margin: 0 auto; 
            width: 100%;
        }

        /* 3. CARD DESIGN */
        .card { 
            background: #2D2F45; 
            padding: 20px; 
            border-radius: 16px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: left;
        }

        /* Typography */
        h1 { 
            font-size: 22px; 
            margin-bottom: 25px; 
            font-weight: 700; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        h3 { 
            margin: 0 0 12px 0; 
            font-size: 14px; 
            color: #A5A6F6; 
            font-weight: 600; 
        }

        /* Row Layout */
        .row { display: flex; gap: 10px; width: 100%; }
        .row button { flex: 1; }

        /* 4. INPUTS */
        input[type="time"] { 
            background: #1C1E2E; 
            color: #fff; 
            border: 1px solid #454766; 
            padding: 14px; 
            border-radius: 10px; 
            width: 100%; 
            font-size: 20px; 
            display: block; 
            margin-bottom: 12px; 
            outline: none;
            appearance: none; 
        }
        
        /* 5. BUTTONS */
        button { 
            border: none; 
            padding: 16px; 
            border-radius: 10px; 
            color: #1a1a2e; 
            font-weight: 700; 
            font-size: 16px; 
            cursor: pointer; 
            width: 100%; 
            transition: transform 0.1s ease;
        }
        button:active { transform: scale(0.98); opacity: 0.9; }
        
        .btn-connect { 
            background: linear-gradient(135deg, #00b4d8, #0077b6); 
            color: white; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 12px rgba(0,180,216, 0.4);
        }

        .btn-action { background: #7B61FF; color: white; }

        .btn-gray { 
            background: #3E415C; 
            color: #E0E0E0; 
            border: 1px solid #4F5270;
        }

        .btn-red { 
            background: #FF4757; 
            color: white; 
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
        }

        /* Terminal - NOW BIGGER */
        #terminal { 
            background: #151621; 
            color: #00FFD4; 
            padding: 15px; 
            border-radius: 10px; 
            height: 140px; 
            overflow-y: auto; 
            font-family: "Courier New", monospace; 
            font-size: 14px; /* <--- CHANGED THIS FROM 11px TO 14px */
            text-align: left; 
            margin-top: 20px;
            border: 1px solid #2D2F45;
        }
    </style>
</head>
<body>

<div class="container">

    <h1>NeckPillowAlarm Web Control</h1>

    <button class="btn-connect" onclick="connect()">üîó Connect BLE</button>

    <div class="card">
        <h3>‚è∞ Set Alarm</h3>
        <input type="time" id="alarmPicker">
        <button class="btn-action" onclick="sendAlarm()">Set Alarm</button>
    </div>

    <div class="card">
        <h3>üïí Set RTC Time (Calibrated use only)</h3>
        <input type="time" id="rtcPicker">
        <button class="btn-action" onclick="sendRTC()">Set RTC</button>
    </div>

    <div class="card">
        <h3>‚öôÔ∏è Settings</h3>
        <div class="row">
            <button class="btn-gray" onclick="send('/unlock')">üîì Unlock</button>
            <button class="btn-gray" onclick="send('/lock')">üîí Lock</button>
        </div>
    </div>

    <div class="card">
        <h3>üîà Audio</h3>
        <div class="row">
            <button class="btn-gray" onclick="send('/sound on')">üîä Sound Mode</button>
            <button class="btn-gray" onclick="send('/sound off')">üîá Vibration Mode</button>
        </div>
    </div>

    <button class="btn-red" onclick="send('/stop')">üõë Stop Alarm</button>

    <div id="terminal">> Waiting for connection...</div>

</div>

<script>
window.onload = function() {
    if (!navigator.bluetooth) {
        log("‚ö†Ô∏è This browser doesn't support Bluetooth.");
        log("iPhone users: Please use the **Bluefy** app.");
    }
};
    // 1. Service Worker for Offline
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(console.log);
    }

    // 2. BLE Setup
    let rxChar, txChar;
    const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; 
    const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; 

    async function connect() {
        try {
            log("Scanning for Nordic UART...");
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERVICE_UUID] }]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            rxChar = await service.getCharacteristic(RX_UUID);
            txChar = await service.getCharacteristic(TX_UUID);

            await txChar.startNotifications();
            txChar.addEventListener('characteristicvaluechanged', (e) => {
                log("Received: " + new TextDecoder().decode(e.target.value));
            });
            log("‚úÖ Connected via Nordic!");
        } catch (error) { log("Error #" + error); }
    }

    async function send(cmd) {
        if (!rxChar) return log("‚ö†Ô∏è Not Connected!");
        try {
            await rxChar.writeValue(new TextEncoder().encode(cmd));
            log("Sent: " + cmd);
        } catch (e) { log("‚ùå Send Failed: " + e); }
    }

    function sendAlarm() {
        const t = document.getElementById('alarmPicker').value;
        t ? send("/alarm " + t) : log("‚ö†Ô∏è Pick a time first!");
    }

    function sendRTC() {
        const t = document.getElementById('rtcPicker').value;
        t ? send("/rtc " + t) : log("‚ö†Ô∏è Pick a time first!");
    }

    function log(msg) {
        const t = document.getElementById('terminal');
        t.innerHTML += "<br>> " + msg;
        t.scrollTop = t.scrollHeight;
    }
</script>

</body>
</html>
